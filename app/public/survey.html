<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" type="text/css" href="./style/style.css">
    <title>Survey</title>
</head>
<body>
    <div class="container">
        <div>
            <h1 class="subtitle">Survey Questions</h1>
        </div>
        <div class="modal" id="modal">
            <div class="modalcontent">
                <span class="close">&times;</span>
                <div class="friendinfo"></div>
            </div>
        </div>
        <div class="aboutyou">
            <h2>About You</h2>
            <form name="form">
                <div class="name">
                    <label for="name">Name (Require)</label>
                    <br>
                    <input type="text" name="name" id="name">
                </div>
                <div class="photo">
                    <label for="photo">Link to your Photo (Require)</label>
                    <br>
                    <input type="text" name="photo" id="photo">
                </div>
                <div>
                    <h2>Question 1</h2>
                    <h3>You love being outdoor</h3> 
                    <select name="question1" id="question1"> Option
                        <option value="" disabled selected>Select an Option</option>
                        <option value="1">1 (Strongly Disagree)</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5 (Strongly Agree)</option>
                    </select>       
                    <h2>Question 2</h2>
                    <h3>Dogs are better than cats</h3>
                    <select name="question2" id="question2">
                        <option value="" disabled selected>Select an Option</option>
                        <option value="1">1 (Strongly Disagree)</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5 (Strongly Agree)</option>
                    </select>
                    <h2>Question 3</h2>
                    <h3>You like organization</h3>
                    <select name="question3" id="question3">
                        <option value="" disabled selected>Select an Option</option>
                        <option value="1">1 (Strongly Disagree)</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5 (Strongly Agree)</option>
                    </select>
                    <h2>Question 4</h2>
                    <h3>Empaty is the most important quality in a person</h3>
                    <select name="question4" id="question4">
                        <option value="" disabled selected>Select an Option</option>
                        <option value="1">1 (Strongly Disagree)</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5 (Strongly Agree)</option>
                    </select>
                    <h2>Question 5</h2>
                    <h3>The law is always black and white</h3>
                    <select name="question5" id="question5">
                        <option value="" disabled selected>Select an Option</option>
                        <option value="1">1 (Strongly Disagree)</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5 (Strongly Agree)</option>
                    </select>
                    <h2>Question 6</h2>
                    <h3>You are into "nerdy" things</h3>
                    <select name="question6" id="question6">
                        <option value="" disabled selected>Select an Option</option>
                        <option value="1">1 (Strongly Disagree)</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5 (Strongly Agree)</option>
                    </select>
                    <h2>Question 7</h2>
                    <h3>You like to be surrounded by people</h3>
                    <select name="question7" id="question7">
                        <option value="" disabled selected>Select an Option</option>
                        <option value="1">1 (Strongly Disagree)</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5 (Strongly Agree)</option>
                    </select>
                    <h2>Question 8</h2>
                    <h3>You care a lot about what others think of you</h3>
                    <select name="question8" id="question8">
                        <option value="" disabled selected>Select an Option</option>
                        <option value="1">1 (Strongly Disagree)</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5 (Strongly Agree)</option>
                    </select>
                    <h2>Question 9</h2>
                    <h3>A little white lie never hurt anyone</h3>
                    <select name="question9" id="question9">
                        <option value="" disabled selected>Select an Option</option>
                        <option value="1">1 (Strongly Disagree)</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5 (Strongly Agree)</option>
                    </select>
                    <h2>Question 10</h2>
                    <h3>You prefers Italian to Asian food</h3>
                    <select name="question10" id="question10">
                        <option value="" disabled selected>Select an Option</option>
                        <option value="1">1 (Strongly Disagree)</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5 (Strongly Agree)</option>
                    </select>
                </div>
            </form>
        </div>
    </div>
    <div>
        <button class="submit">Submit</button>
        </a>
    </div>
    <footer class="footer">
        <div>
            <a href="/api/friends">API Friends List</a>
            <a href="https://github.com/anniekpham/FriendFinder">Github Repo</a>
        </div>
    </footer>
<script>
const {fetch, alert} = window

let yourinfo = {},
    totalscore = [],
    name = document.getElementById('name'),
    photo = document.forms['form']['photo'],
    modal = document.getElementById("modal"),
    question1 = document.forms['form']['question1'],
    question2 = document.forms['form']['question2'],
    question3 = document.forms['form']['question3'],
    question4 = document.forms['form']['question4'],
    question5 = document.forms['form']['question5'],
    question6 = document.forms['form']['question6'],
    question7 = document.forms['form']['question7'],
    question8 = document.forms['form']['question8'],
    question9 = document.forms['form']['question9'],
    question10 = document.forms['form']['question10']
    
const yourfriend = (totalscore, friends) => {
    let min = totalscore[0]
    let minindex = 0
    for(i = 1; i < totalscore.length; i++) {
        if(totalscore[i] < min) {
            minindex = i
            min = totalscore[i]
        }
    }
    if (totalscore.length === friends.length) {
        document.querySelector('.friendinfo').innerHTML = `
        <h1 class='bestmatch'>Best Match</h1>
        <h2>${friends[minindex].name}</h2>
        <img src=${friends[minindex].photo} alt="${friends[minindex].name}">
        `
    }
}

// function sometimes returns an empty array a long with the other one and break the matching(can't figure out why)
const matching = yourinfo => {
    fetch('/api/friends')
    .then(r => r.json())
    .then(friends => {
        friends.forEach(friend => {
            let length = Math.min(friend.scores.length,yourinfo.scores.length)
            let remainarr = []
            for (i = 0; i < length; i++) {
                if(friend.scores[i] != yourinfo.scores[i]) {
                    remaining = Math.abs(yourinfo.scores[i] - friend.scores[i])
                    remainarr.push(remaining)
                }
            }
            function getSum(total, num) {
                return total + num;
            }
            totalscore.push(remainarr.reduce(getSum))
            yourfriend(totalscore, friends)
        })
    })
    .catch(e => console.log(e))
}


document.querySelector('.submit').addEventListener('click', e => {
    e.preventDefault()
    if (name.value === '' || photo.value === '' || question1.selectedIndex < 1 || question2.selectedIndex < 1 || question3.selectedIndex < 1 || question4.selectedIndex < 1 || question5.selectedIndex < 1 || question6.selectedIndex < 1 || question7.selectedIndex < 1 || question8.selectedIndex < 1 || question9.selectedIndex < 1 || question10.selectedIndex < 1) {
        alert('Please fill out form')
    }
    else {
        yourinfo = {
            name: document.querySelector('#name').value,
            photo: document.querySelector('#photo').value,
            scores: [
                parseInt(document.querySelector('#question1').value),
                parseInt(document.querySelector('#question2').value),
                parseInt(document.querySelector('#question3').value),
                parseInt(document.querySelector('#question4').value),
                parseInt(document.querySelector('#question5').value),
                parseInt(document.querySelector('#question6').value),
                parseInt(document.querySelector('#question7').value),
                parseInt(document.querySelector('#question8').value),
                parseInt(document.querySelector('#question9').value),
                parseInt(document.querySelector('#question10').value)
            ]
        }
        console.log(yourinfo)
        matching(yourinfo)
        fetch('/api/friends', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: document.querySelector('#name').value,
                photo: document.querySelector('#photo').value,
                scores: [
                    parseInt(document.querySelector('#question1').value),
                    parseInt(document.querySelector('#question2').value),
                    parseInt(document.querySelector('#question3').value),
                    parseInt(document.querySelector('#question4').value),
                    parseInt(document.querySelector('#question5').value),
                    parseInt(document.querySelector('#question6').value),
                    parseInt(document.querySelector('#question7').value),
                    parseInt(document.querySelector('#question8').value),
                    parseInt(document.querySelector('#question9').value),
                    parseInt(document.querySelector('#question10').value)
                ]
            })
        })
        .then(_ => console.log(yourinfo))
        .catch(e => console.log(e))
        modal.style.display = 'block'
    }
})

document.getElementsByClassName("close")[0].addEventListener('click', _ => {
    modal.style.display = 'none'
})

</script>

</body>
</html>